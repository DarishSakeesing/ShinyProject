---
title: "Data Cleaning"
author: "Darish Sakeesing"
date: "1/29/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Brief Introduction

This project is an attempt at the analysis of the market of Electric Vehicles, for example, what type of electric vehicle is more popular and what manufacturers are leading the industry. The purpose of the project is to inform its audience, whether consumers or policy makers, so that they can make the best decisions in their situation. 

Before we can use the data, we have to import it and clean it.

```{r Importing}
df_2012 <- read.csv('data/ev_2012.csv', header = T)
df_2013 <- read.csv('data/ev_2013.csv', header = T)
df_2014 <- read.csv('data/ev_2014.csv', header = T)
df_2015 <- read.csv('data/ev_2015.csv', header = T)
df_2016 <- read.csv('data/ev_2016.csv', header = T)
df_2017 <- read.csv('data/ev_2017.csv', header = T)
df_2018 <- read.csv('data/ev_2018.csv', header = T)
df_2018 <- read.csv('data/ev_2018.csv', header = T)
df_2019 <- read.csv('data/ev_2019.csv', header = T)


cumulative_df <- read.csv('data/cumulative_sales.csv', header = T)

```

```{r Cleaning}
library(dplyr)
library(stringr)
library(tidyr)
library(lubridate)
library(xts)

# ---- Cleaning the 2012 data ----
df_2012 <- df_2012 %>% 
  select(1:13) %>% 
  filter(X2012 != 'InsideEVs') %>% 
  rename(Make_Model = X2012) %>% 
  mutate(Make = word(Make_Model, 1)) %>%
  mutate(Model = word(Make_Model, 2, -1)) %>%
  select(Make, Model, 2:13) %>%
  pivot_longer(cols = 3:14, names_to = 'Month', values_to = 'Sales') %>%
  mutate(Year = 2012) %>%
  select(Make, Model, Month, Year, Sales)



# ---- Cleaning the 2013 data ----
df_2013 <- df_2013 %>%
  select(1:13) %>% 
  filter(X2013 != 'InsideEVs') %>% 
  rename(Make_Model = X2013) %>%
  mutate(Make = word(Make_Model, 1)) %>%
  mutate(Model = word(Make_Model, 2, -1)) %>%
  select(Make, Model, 2:13) %>%
  pivot_longer(cols = 3:14, names_to = 'Month', values_to = 'Sales') %>%
  mutate(Year = 2013) %>%
  select(Make, Model, Month, Year, Sales)


# ---- Cleaning the 2014 data ----
df_2014 <- df_2014 %>%
  select(1:13) %>% 
  filter(X2014.US != 'InsideEVs' & X2014.US != 'Worldwide') %>% 
  rename(Make_Model = X2014.US) %>%
  mutate(Make = word(Make_Model, 1)) %>%
  mutate(Model = word(Make_Model, 2, -1)) %>%
  select(Make, Model, 2:13) %>%
  pivot_longer(cols = 3:14, names_to = 'Month', values_to = 'Sales') %>%
  mutate(Year = 2014) %>%
  select(Make, Model, Month, Year, Sales)


# ---- Cleaning the 2015 data ----
df_2015 <- df_2015 %>%
  select(1:13) %>% 
  filter(X2015.US != 'InsideEVs' & X2015.US != '2014 Results' & X2015.US != 'Worldwide*') %>% 
  rename(Make_Model = X2015.US) %>%
  mutate(Make = word(Make_Model, 1)) %>%
  mutate(Model = word(Make_Model, 2, -1)) %>%
  select(Make, Model, 2:13) %>%
  pivot_longer(cols = 3:14, names_to = 'Month', values_to = 'Sales') %>%
  mutate(Year = 2015) %>%
  select(Make, Model, Month, Year, Sales)



# ---- Cleaning the 2016 data ----
df_2016 <- df_2016 %>%
  select(1:13) %>% 
  filter(X2016.US != 'InsideEVs' & X2016.US != '2015 Results' & X2016.US != 'Worldwide*') %>% 
  rename(Make_Model = X2016.US) %>%
  mutate(Make = word(Make_Model, 1)) %>%
  mutate(Model = word(Make_Model, 2, -1)) %>%
  select(Make, Model, 2:13) %>%
  pivot_longer(cols = 3:14, names_to = 'Month', values_to = 'Sales') %>%
  mutate(Year = 2016) %>%
  select(Make, Model, Month, Year, Sales)



# ---- Cleaning the 2017 data ----
df_2017 <- df_2017 %>%
  select(1:13) %>% 
  filter(X2017.U.S..EV.SALES != '2017 U.S. Sales Totals' & X2017.U.S..EV.SALES != '2016 U.S. Sales Totals' & X2017.U.S..EV.SALES != '2017 Worldwide Sales*') %>% 
  rename(Make_Model = X2017.U.S..EV.SALES) %>%
  mutate(Make = word(Make_Model, 1)) %>%
  mutate(Model = word(Make_Model, 2, -1)) %>%
  select(Make, Model, 2:13) %>%
  pivot_longer(cols = 3:14, names_to = 'Month', values_to = 'Sales') %>%
  mutate(Year = 2017) %>%
  select(Make, Model, Month, Year, Sales)


# ---- Cleaning the 2018 data ----
df_2018 <- df_2018 %>%
  select(1:13) %>% 
  filter(X2018.U.S..EV.SALES != '2018 U.S. Sales Totals' & X2018.U.S..EV.SALES != '2017 U.S. Sales Totals' & X2018.U.S..EV.SALES != '2018 Worldwide Sales*') %>% 
  rename(Make_Model = X2018.U.S..EV.SALES) %>%
  mutate(Make = word(Make_Model, 1)) %>%
  mutate(Model = word(Make_Model, 2, -1)) %>%
  select(Make, Model, 2:13) %>%
  pivot_longer(cols = 3:14, names_to = 'Month', values_to = 'Sales') %>%
  mutate(Year = 2018) %>%
  select(Make, Model, Month, Year, Sales)


# ---- Cleaning the 2019 data ----
df_2019 <- df_2019 %>%
  select(2:14) %>% 
  filter(X != '2019 U.S. Sales Totals*' & X != '2018 U.S. Sales Totals*' & X != '2019 Worldwide Sales*' & X != '2018 Worldwide Sales*') %>% 
  rename(Make_Model = X) %>%
  mutate(Make = word(Make_Model, 1)) %>%
  mutate(Model = word(Make_Model, 2, -1)) %>%
  select(Make, Model, 2:13) %>%
  pivot_longer(cols = 3:14, names_to = 'Month', values_to = 'Sales') %>%
  mutate(Year = 2019) %>%
  select(Make, Model, Month, Year, Sales)


df_2019[] <- lapply(df_2019, gsub, pattern = '\U0001f50b', replacement = '')

```


```{r fun}

create_date <- function(df) {
  df$Month = match(str_to_title(df$Month), month.abb)
  df$Date <- as.yearmon(paste(df$Year, df$Month), "%Y %m")
  #df <- df %>%
   # select(Make, Model, Date, Sales)
  
  return(df$Date)
}

df_2012 <- create_date(df_2012)
df_2013 <- create_date(df_2013)
df_2014 <- create_date(df_2014)
df_2015 <- create_date(df_2015)
df_2016 <- create_date(df_2016)
df_2017 <- create_date(df_2017)
df_2018 <- create_date(df_2018)
df_2019 <- create_date(df_2019)

```

```{r Combining the data into a single CSV}

cleaned_total_df <- rbind(df_2012, df_2013, df_2014, df_2015, df_2016, df_2017, df_2018, df_2019)

write.csv(cleaned_total_df,"data/cleaned_data.csv")

```
```{r Cleaning cumulative sales file}
library(dplyr)
library(ggplot2)
library(stringr)
library(xts)

df <- read.csv('data/cumulative_sales.csv') %>% 
  mutate(PHEV = as.numeric(gsub(',', '', df$PHEV)), BEV = as.numeric(gsub(',', '', df$BEV))) %>%
  mutate(Total = PHEV + BEV)

df <- df %>%
  mutate(month1 = word(Month, 1, sep = '-')) %>%
  mutate(Year = word(Month, 2, sep = '-')) %>%
  mutate(Month = month1, Year = as.numeric(Year) + 2000) %>%
  select(Month, Year, PHEV, BEV, Percent.EV, Total)


df$Date <- create_date(df)

df <- read.csv('data/cumSales.csv')

df$Date <- as.Date(as.yearmon(df$Date))

write.csv(df,"data/cumSales.csv")

```


```{r Car Specs Cleaning}
library(dplyr)
library(ggplot2)
library(stringr)
library(stringi)

top_speed_df <- read.csv('data/top_speed.csv')

top_speed_df<- top_speed_df %>% filter(Top.Speed..km.h. != 'Average') %>% mutate(Make = word(Car, 1), Model = word(Car, 2, -1)) %>% mutate(Speed = as.numeric(Top.Speed..km.h.)) %>% select(Make, Model, Speed) %>% mutate(Model = toupper(Model))

testdf <- cleaned_df %>%
  mutate(Sales = gsub(',', '', cleaned_df$Sales)) %>%
  mutate(Sales = as.numeric(Sales)) %>%
  na.omit(cleaned_df)

testdf$Model <- str_replace(testdf$Model, '\\*', '')
testdf$Model <- toupper(testdf$Model)
testdf$Model <- str_trim(testdf$Model)



salesdf <- testdf %>% group_by(Make, Model) %>% summarise(TotalSales = sum(Sales))

salesdf <- salesdf[order(salesdf$TotalSales, decreasing = T),]

```
